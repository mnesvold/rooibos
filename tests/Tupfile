include_rules

ROOIBUS = $(TUP_CWD)/../rooibus/rooibus-codegen
ESGENERATE = $(ROOT)/tools/node_modules/.bin/esgenerate
UGLIFY = $(ROOT)/tools/node_modules/.bin/uglifyjs

# Generate unoptimized bitcode
: foreach *.c |> $(BIN)/clang -c -emit-llvm -o %o -O0 %f |> %B.bc {bc}

# Use specific optimizations
: foreach {bc} |> $(BIN)/opt -mem2reg %f > %o |> %B.bc-opt {bcopt}

# Generate human-readable version (for debugging)
: foreach {bcopt} |> $(BIN)/llvm-dis -o %o %f |> %B.ll

# Generate JavaScript AST
: foreach {bcopt} | $(ROOIBUS) |> $(ROOIBUS) < %f > %o |> %B.json {ast}

# Generate Javascript
: foreach {ast} |> $(ESGENERATE) %f > %o |> %B.js {js}

# Minify (for comparison's sake)
: foreach {js} |> $(UGLIFY) %f > %o |> %B.min.js

# Check against expected result
: foreach {js} |> diff %B.expected.js %f && touch %o |> %B.ok
